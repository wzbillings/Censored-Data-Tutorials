{
  "hash": "f6026583b6e985001c4967aeb5f7dcfb",
  "result": {
    "engine": "knitr",
    "markdown": "# Example Model 6: the HAI manifesto\n\n\n\n\n\nMost of my research about the influenza vaccine is focused on the analysis of\nHemagglutination Inhibition (HAI) assay data. These data are proxies for\nneutralizing influenza antibodies, and have the advantage of being easy to\nperform and being able to capture cross-reactivity across different strains of\ninfluenza. However, the assay has a unique data generating process. I've\ndiscussed this before in a few posts on my blog (\n[first](https://wzbillings.com/posts/2023-07-25_simulating-titer-data/),\n[second](https://wzbillings.com/posts/2023-08-10_titer-w-distance/)), but I\nnever got to the part where we actually fit the models to make sure our\ncensoring approach works.\n\nHAI makes a potentially interesting example because of three features of the\ndata:\n\n1. The outcome is left censored with a lower limit of detection;\n1. The outcome is interval censored for values above the LLOD; and\n1. There are two appropriate models, which we can compare and contrast.\n\nFor all of these models, we'll work under one general example study. Suppose\nwe recruit $n$ patients for a study and give them a flu vaccine. For each of\nthose patients, we collect their pre-vaccination titer and post-vaccination\n(say at 28 days) to 11 different influenza strains. These strains include the\nsame strain that is in the vaccine (which has distance $0$), and ten other\nstrains, which each have distances $d = \\{0.1, 0.2, 0.3, \\ldots, 1.0\\}$. The\noutcome variable, post-vaccination titers, will be left-censored and also\ninterval-censored. We assume that the mean of the outcome is a linear\nfunction of the distance. Unfortunately the two models we need to consider\nare hard to describe in the same language, so we'll get down to brass tacks\nwith the data generating process (DGP) in the respective sections.\n\nFor dealing with interval censored data, we will pass the\ndata to Stan using the `interval2` format from the `survival` package. In this\nformat, we pass two columns, say `y_l` and `y_u`. If a data point is not\ncensored, then `y_l == y_u`. If a data point is left-censored, then `y_l = -Inf`\nand `y_u` is set to the lower limit of detection. Similarly, if a data point\nis right-censored, `y_l` is set to the upper limit of detection and `y_u = Inf`.\nFinally, if a data point is interval-censored, `y_l` and `y_u` are set to the\nlower and upper bounds of the interval containing the datum, respectively.\n\n## Log-normal model\n\nBoth of these models will share a lot of similarities, but for some reason\nI find the lognormal model easier to think about, so we'll do most of the\nexplaining under the context of this model. We start with the assumption that\nour *underyling, latent titer* value (the \"true titer\") is some real number\nwhich follows a log-normal distribution. We assume that the mean of this\ndistribution is a linear function of the antigenic distance, as we mentioned,\nand we assume constant variance. In math terms, we assume that\n$$\ny_i^* \\sim \\text{Log-normal}\\left(\\frac{\\beta_0 + \\beta_1 x_i}{\\log_2 e}, \\frac{\\sigma}{\\log_2 e}\\right).\n$$ {#eq-ln-model}\nNote that we scale the coefficients by a factor of $\\frac{1}{\\log_2{e}}$\nbecause\n$$\\log{y_i^*} \\sim \\text{Normal}\\left( \\frac{\\beta_0 + \\beta_1 x_i}{\\log_2 e}, \\frac{\\sigma}{\\log_2 e} \\right),$$\nwhich combined with the identity that\n$$\\log{y_i^*} = \\frac{\\log_2 y_i^*}{\\log_2{e}},$$\nimplies\n$$ \\log_2 y_i^* \\sim \\text{Normal}\\left( \\beta_0 + \\beta_1 x_i, \\sigma \\right) .$$\nThis gives us a connection to the natural units of measurement, and makes it\neasier to understand the models and set priors.\n\n## Gamma model\n\nThe gamma model and lognormal model are both right-skewed families which\ncan also approximate normal distributions with the correct set of parameter\nvalues. However, the gamma family is somewhat more flexible in the\nranges of shapes it can take on, and includes exponential and chi-squared\ndistributions (as examples of shapes which are difficult to match with the\nlog-normal distribution). Additionally, the variance of the log-normal family\nis independent of the mean, while the variance of the gamma family is\nproportional to the mean. (Another way to say that is that the coefficient of\nvariation of the log-normal model is always constant, while the coefficient of\nvariation of the gamma model is constant for a given value of the mean, which\nincreases as the mean increases.)\n\nWhile the log of a gamma random variable does not have a simple interpretation\nlike the log-normal family does, there are known formulas for the moments of\nthis distribution. However, they require complex calculations using\nderivatives of the gamma function. Notably, there is also a generalized\ngamma distribution which has been proposed (CITE THIS) as a general model\nfor fitting antibody assay data, but this distribution is not common in\npractice.\n\n::: {.callout-note icon=false collapse=true appearance=\"simple\"}\n\n### Gamma distribution parametrization {.unnumbered}\nThere are at least three common reparametrizations of the Gamma parametrization.\n[Stan](https://mc-stan.org/docs/functions-reference/gamma-distribution.html)\nimplements the standard \"shape-scale\" parametrization, which is most commonly\nused by statisticians. In the `rethinking` package, Richard McElreath implements\na \"mean-scale\" parametrization which uses the substitution\n$\\alpha = \\mu / \\beta$. **However**, in a GLM context, the most frequently\nused parametrization is the \"shape-mean\" parametrization (CITE AGRESTI AND\nMCCULOUGH NELDER). \n\nBeginning with the parametrization made in the Stan guide, we make the\nsubstitutions $\\alpha = k$ and $\\beta = \\frac{k}{\\mu}$.\nBy making those substitutions in the density, we can show that\n$$E(y) = \\mu \\quad \\text{and} \\quad \\mathrm{Var}(y) = \\frac{\\mu^2}{k}.$$\n\nWhen we specify $\\mu = f(X)$ in the context of a linear model, we must then\ninvert the transformation, and when we invoke the gamma distribution in Stan,\nwe would write\n$$y \\sim \\text{Gamma}\\left(k, \\frac{k}{\\mu} \\right).$$\n\n:::\n\nTo specify a gamma likelihood for our titer outcome, we would write in math\nterms that\n$$\n\\begin{align*}\ny_i^* &\\sim \\text{Gamma}\\left(k, \\frac{k}{\\mu_i}\\right) \\\\\ng(\\mu_i) &= \\beta_0 + \\beta_1 x_i\n\\end{align*}\n$$ {#eq-gamma-model}\nwhere $g(\\cdot)$ is a suitably-chosen link function. Note that the parameters of\nthe gamma distribution must be greater than zero, necessitating the use of a\nnon-identity link function, in contrast to the log-normal distribution where no\nlink function is necessary. The canonical link function here is $g(x) = -1/x$,\nwhich is really a pretty useless link function in a real life context because it\nrequires us to place constraints on the $\\beta_i$ values. So, use of the link\nfunction $g(x) = \\exp(x)$ is more common, and is what we would use here.\n\nBecause the gamma distribution does not have an easily-interpretable formula\non the log-scale, we fit the distribution on the natural scale of the parameter\n(although I guess we could also fit a gamma model to the log-scale outcome, but\nthis is unusual) and thus we do not need to worry about the scaling of the\nparameters. Once again: **there is no easy interpretation of the gamma\nregression parameters on the log-scale.**\n\n**NEED TO CITE https://www.jstor.org/stable/2685723?searchText=&searchUri=&ab_segments=&searchKey=&refreqid=fastly-default%3A7ee1f3ec4603b86f40438da20e839c33 and Moulton/Halsey**\n\n## The observation model\n\nOK, so that would be great if that was all we had to do. But unfortunately,\nas I mentioned, HAI titers are interval censored and have a lower limit of\ndetection, which we need to include in our model. We do this following the\ntraditional method of updating the likelihood directly. Because of the way that\nthe censoring mechanism occurs in practice, we need to define our censoring\nmechanism on the log scale. So, define\n$$z_i^* = f(y_i^*) = \\log_2 \\left(\\frac{y_i^*}{5}\\right).$$ {#eq-transform}\nNotably, this implies that\n$$y_i^* = f^{-1}(z_i^*) = 5\\cdot 2^{z_i^*}.$$\nThe assay is performed by two-fold dilutions, so we actually observe the\nlog-scale value during the measurement process. The limit of detection for the\nassay is conventionally 1:10, though it could be as low as 1:4 (CITE THAT\nTHING AMANDA SENT ME). However, due to the reagents necessary to run the assay\nthere is a physical limit of detection, and 1:10 has been adopted as a widely\nused standard in influenza research. For convenience, we will only consider the\nreciprocal titers, so a titer of 1:10 would be reported as 10. Note that\n$$\nf(10) = \\log_2 2 = 1,\n$$\nso 1 is the LoD on the log scale, any any values strictly less than one are\nbelow the LoD. Following standard conventions, we write these values as 5 on\nthe natural scale, or 0 on the log scale.\n\nNote also that the measurement process reflects a discretization of an\nunderyling continuous value. The HAI titer measurement is defined as the lowest\npossible dilution of serum which inhibits agglutination. This value could be,\nfor example, a dilution of 12.5443 (on the natural scale), but we would observe\nthis as a titer of 10 in our assay. Equivalently, the true latent log-scale\ntiter might be 1.327, which we would observe as 1. See Figure @fig-hai-plot for\nan example showing the raw lab assay.\n\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Example HAI titer data that we would observe while doing the\nassay in the lab. These assays are run on 96-well plates, where each row\nis a separate assay and each column is a serial two-fold dilution,\nbeginning at a dilution of 1:10 (of the serum) and progressing rightwards.](HAI-plot.png){#fig-hai-plot width=1800}\n:::\n:::\n\n\nA convenient way to write this is by\nnoticing that we take the floor of all values on the log scale. So, we can\nwrite our data observation model as\n$$\ny_i = \\begin{cases}\n0, & y_i^* < 1 \\\\\n\\left\\lfloor y_i^* \\right\\rfloor, & y_i^* \\geq 1\n\\end{cases}\n$$ {#eq-observation-model}\n\nwhere $y_i^*$ is the latent true titer and $y_i$ is the observed titer.\n\n## Data simulations\n\nThe first thing we need to do now is simulate some titers. We probably want\nto simulate data from both of those two models, in order to see how the\ndistributions differ. So, we'll ensure that the linear regression coefficients\nare the same, and we can see what happens in both models. \n\n## Midpoint correction instead of interval censoring\n\n## Extensions to consider in the future\n\n* An individual is randomly missing strains due to laboratory errors\n* Repeated measures across study years\n* Repeated measures across study years where some strains are systematically\nmissing based on the year\n* Models which control for pre-vaccination titer.\n\n<!-- END OF FILE -->\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}